# .github/workflows/main.yml
name: Build WhisperDesk for All Platforms

on:
  push:
    branches: [ main, release ]
    tags: [ 'v*' ]
  pull_request:
    branches: [ main ]

# Add explicit permissions for the workflow
permissions:
  contents: write
  actions: read
  checks: write
  pull-requests: write

jobs:
  build:
    strategy:
      matrix:
        include:
          - os: macos-latest
            platform: darwin
            arch: x64
            artifact: WhisperDesk-mac-x64
          - os: macos-latest
            platform: darwin
            arch: arm64
            artifact: WhisperDesk-mac-arm64
          - os: ubuntu-latest
            platform: linux
            arch: x64
            artifact: WhisperDesk-linux-x64
          - os: windows-latest
            platform: win32
            arch: x64
            artifact: WhisperDesk-windows-x64

    runs-on: ${{ matrix.os }}

    steps:
    - name: Checkout code
      uses: actions/checkout@v4
      with:
        fetch-depth: 0

    - name: Setup Node.js
      uses: actions/setup-node@v4
      with:
        node-version: '18'
        cache: 'npm'

    - name: Setup pnpm
      uses: pnpm/action-setup@v4
      with:
        version: latest

    # Platform-specific dependencies
    - name: Install Linux dependencies
      if: runner.os == 'Linux'
      run: |
        sudo apt-get update
        sudo apt-get install -y build-essential cmake libasound2-dev
        # For AppImage creation
        sudo apt-get install -y fuse libfuse2

    - name: Install macOS dependencies
      if: runner.os == 'macOS'
      run: |
        # Install Xcode command line tools if not present
        xcode-select --install || true
        # Install cmake via homebrew (explicitly specify formula to avoid warning)
        brew install --formula cmake

    - name: Install Windows dependencies
      if: runner.os == 'Windows'
      run: |
        # Install Visual Studio Build Tools
        choco install visualstudio2022buildtools --package-parameters "--add Microsoft.VisualStudio.Workload.VCTools"
        # Install cmake
        choco install cmake

    # Install main dependencies
    - name: Install main dependencies
      run: npm install

    # Install renderer dependencies
    - name: Install renderer dependencies
      run: |
        cd src/renderer/whisperdesk-ui
        pnpm install --frozen-lockfile

    # Build whisper.cpp from source
    - name: Build whisper.cpp (Linux/macOS)
      if: runner.os != 'Windows'
      run: |
        git clone https://github.com/ggerganov/whisper.cpp.git /tmp/whisper.cpp
        cd /tmp/whisper.cpp
        make -j$(nproc 2>/dev/null || sysctl -n hw.ncpu || echo 4)
        mkdir -p binaries
        cp build/bin/whisper-cli ./binaries/whisper 2>/dev/null || cp whisper-cli ./binaries/whisper
        chmod +x ./binaries/whisper
        # Copy to project
        mkdir -p $GITHUB_WORKSPACE/binaries
        cp ./binaries/whisper $GITHUB_WORKSPACE/binaries/whisper

    - name: Build whisper.cpp (Windows)
      if: runner.os == 'Windows'
      shell: pwsh
      run: |
        git clone https://github.com/ggerganov/whisper.cpp.git C:\temp\whisper.cpp
        cd C:\temp\whisper.cpp
        New-Item -ItemType Directory -Force -Path "build"
        cd build
        cmake .. -DCMAKE_BUILD_TYPE=Release
        cmake --build . --config Release
        # Copy to project using proper PowerShell syntax
        New-Item -ItemType Directory -Force -Path "$env:GITHUB_WORKSPACE\binaries"
        Copy-Item "bin\Release\whisper-cli.exe" "$env:GITHUB_WORKSPACE\binaries\whisper.exe" -Force

    # Download tiny model for inclusion
    - name: Download tiny model
      run: |
        mkdir -p models
        curl -L -o models/ggml-tiny.bin https://huggingface.co/ggerganov/whisper.cpp/resolve/main/ggml-tiny.bin

    # Build renderer
    - name: Build renderer
      run: |
        cd src/renderer/whisperdesk-ui
        pnpm run build

    # Build Electron app for specific platform
    - name: Build Electron app (macOS x64)
      if: matrix.platform == 'darwin' && matrix.arch == 'x64'
      env:
        CSC_IDENTITY_AUTO_DISCOVERY: false
      run: npm run build && npx electron-builder --mac --x64 --publish=never

    - name: Build Electron app (macOS ARM64)
      if: matrix.platform == 'darwin' && matrix.arch == 'arm64'
      env:
        CSC_IDENTITY_AUTO_DISCOVERY: false
      run: npm run build && npx electron-builder --mac --arm64 --publish=never

    - name: Build Electron app (Linux)
      if: matrix.platform == 'linux'
      run: npm run build && npx electron-builder --linux --publish=never

    - name: Build Electron app (Windows)
      if: matrix.platform == 'win32'
      env:
        CSC_IDENTITY_AUTO_DISCOVERY: false
      run: npm run build && npx electron-builder --win --publish=never

    # Upload artifacts
    - name: Upload macOS artifacts
      if: matrix.platform == 'darwin'
      uses: actions/upload-artifact@v4
      with:
        name: ${{ matrix.artifact }}
        path: |
          dist/*.dmg
          dist/*.zip
        retention-days: 30

    - name: Upload Linux artifacts
      if: matrix.platform == 'linux'
      uses: actions/upload-artifact@v4
      with:
        name: ${{ matrix.artifact }}
        path: |
          dist/*.AppImage
          dist/*.deb
          dist/*.rpm
          dist/*.tar.gz
        retention-days: 30

    - name: Upload Windows artifacts
      if: matrix.platform == 'win32'
      uses: actions/upload-artifact@v4
      with:
        name: ${{ matrix.artifact }}
        path: |
          dist/*.exe
          dist/*.zip
        retention-days: 30

  # Create release if this is a tag
  release:
    if: startsWith(github.ref, 'refs/tags/v')
    needs: build
    runs-on: ubuntu-latest
    
    # Explicit permissions for the release job - this is the key fix
    permissions:
      contents: write
      actions: read
      id-token: write  # Added this for enhanced security
      
    steps:
    - name: Checkout code
      uses: actions/checkout@v4
      with:
        fetch-depth: 0

    - name: Download all artifacts
      uses: actions/download-artifact@v4
      with:
        path: artifacts

    - name: Display structure of downloaded files
      run: |
        echo "Artifact structure:"
        ls -la artifacts/
        find artifacts/ -type f -name "*.dmg" -o -name "*.zip" -o -name "*.exe" -o -name "*.AppImage" -o -name "*.deb" -o -name "*.rpm" | head -20

    # Debug token permissions (optional - remove after testing)
    - name: Debug GitHub token permissions
      run: |
        echo "GITHUB_TOKEN permissions test"
        echo "Repository: ${{ github.repository }}"
        echo "Actor: ${{ github.actor }}"
        echo "Ref: ${{ github.ref }}"
        echo "Event: ${{ github.event_name }}"

    - name: Create Release
      uses: softprops/action-gh-release@v1  # Changed back to v1 for stability
      with:
        files: artifacts/**/*
        draft: false
        prerelease: false
        generate_release_notes: true
        name: "WhisperDesk Enhanced ${{ github.ref_name }}"
        body: |
          ## WhisperDesk Enhanced ${{ github.ref_name }}
          
          üéâ **New Release Available!**
          
          ### üì¶ Download Options:
          - **Windows**: `WhisperDesk-windows-x64.exe` 
          - **macOS Intel**: `WhisperDesk-mac-x64.dmg`
          - **macOS Apple Silicon**: `WhisperDesk-mac-arm64.dmg`
          - **Linux**: `WhisperDesk-linux-x64.AppImage` (portable) or `.deb`/`.rpm` packages
          
          ### ‚ú® Features:
          - üéµ Native whisper.cpp integration for fast, offline transcription
          - üì± Cross-platform support (Windows, macOS, Linux)
          - üîÑ Real-time progress tracking
          - üíæ Persistent state management
          - üéØ Multiple model support (Tiny, Base, Small, Medium, Large)
          - üìÅ Drag & drop file upload
          - üé® Modern, responsive UI
          
          ### üöÄ Quick Start:
          1. Download the appropriate file for your platform
          2. Install and launch WhisperDesk
          3. Go to Models tab and download a transcription model
          4. Upload audio/video files and start transcribing!
          
          Auto-generated release notes below ‚¨áÔ∏è
      env:
        GITHUB_TOKEN: ${{ secrets.GITHUB_TOKEN }}