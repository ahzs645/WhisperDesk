# .github/workflows/main.yml - UPDATED with official whisper.cpp build approach
name: Build WhisperDesk for All Platforms

on:
  push:
    branches: [ main, release ]
    tags: [ 'v*' ]
  pull_request:
    branches: [ main ]

permissions:
  contents: write
  actions: read
  checks: write
  pull-requests: write

jobs:
  build:
    strategy:
      matrix:
        include:
          - os: macos-latest
            platform: darwin
            arch: x64
            artifact: WhisperDesk-mac-x64
            electron_arch: x64
            electron_target: --mac --x64
          - os: macos-latest
            platform: darwin
            arch: arm64
            artifact: WhisperDesk-mac-arm64
            electron_arch: arm64
            electron_target: --mac --arm64
          - os: ubuntu-latest
            platform: linux
            arch: x64
            artifact: WhisperDesk-linux-x64
            electron_arch: x64
            electron_target: --linux --x64
          - os: windows-latest
            platform: win32
            arch: x64
            artifact: WhisperDesk-windows-x64
            electron_arch: x64
            electron_target: --win --x64

    runs-on: ${{ matrix.os }}

    steps:
    - name: Checkout code
      uses: actions/checkout@v4
      with:
        fetch-depth: 0

    - name: Setup Node.js
      uses: actions/setup-node@v4
      with:
        node-version: '18'
        cache: 'npm'

    - name: Setup pnpm
      uses: pnpm/action-setup@v4
      with:
        version: latest

    # Platform-specific dependencies
    - name: Install Linux dependencies
      if: runner.os == 'Linux'
      run: |
        sudo apt-get update
        sudo apt-get install -y build-essential cmake libasound2-dev
        sudo apt-get install -y fuse libfuse2

    - name: Install macOS dependencies
      if: runner.os == 'macOS'
      run: |
        # Install Xcode command line tools if not present
        xcode-select --install || true
        # Install cmake via homebrew
        brew install cmake

    - name: Add MSBuild to PATH (Windows)
      if: runner.os == 'Windows'
      uses: microsoft/setup-msbuild@v2

    # Extract version from tag and update package.json
    - name: Set version from tag
      shell: bash
      run: |
        if [ "${{ github.ref_type }}" = "tag" ]; then
          # Extract version from tag (remove 'v' prefix)
          VERSION="${{ github.ref_name }}"
          VERSION="${VERSION#v}"  # Remove 'v' prefix if present
          
          echo "üè∑Ô∏è Setting version to: $VERSION"
          
          # Update main package.json
          if command -v jq &> /dev/null; then
            # Use jq if available
            jq --arg version "$VERSION" '.version = $version' package.json > package.json.tmp && mv package.json.tmp package.json
          else
            # Fallback to sed
            sed -i.bak "s/\"version\": \".*\"/\"version\": \"$VERSION\"/" package.json
          fi
          
          echo "‚úÖ Updated main package.json version to: $VERSION"
          grep '"version"' package.json
          
          # Also set as environment variable for electron-builder
          echo "APP_VERSION=$VERSION" >> $GITHUB_ENV
        else
          echo "üîß Not a tag build, keeping existing version"
          CURRENT_VERSION=$(node -p "require('./package.json').version")
          echo "APP_VERSION=$CURRENT_VERSION" >> $GITHUB_ENV
        fi

    # Install main dependencies
    - name: Install main dependencies
      run: npm install

    # Install renderer dependencies
    - name: Install renderer dependencies
      shell: bash
      run: |
        cd src/renderer/whisperdesk-ui
        
        # Update renderer package.json version if this is a tag build
        if [ "${{ github.ref_type }}" = "tag" ]; then
          VERSION="${{ github.ref_name }}"
          VERSION="${VERSION#v}"
          
          echo "üè∑Ô∏è Updating renderer package.json version to: $VERSION"
          
          if command -v jq &> /dev/null; then
            jq --arg version "$VERSION" '.version = $version' package.json > package.json.tmp && mv package.json.tmp package.json
          else
            sed -i.bak "s/\"version\": \".*\"/\"version\": \"$VERSION\"/" package.json
          fi
          
          echo "‚úÖ Updated renderer package.json version"
          grep '"version"' package.json
        fi
        
        pnpm install --frozen-lockfile

    # Build whisper.cpp from source - UNIX platforms
    - name: Build whisper.cpp (Linux/macOS)
      if: runner.os != 'Windows'
      run: |
        echo "üî® Building whisper.cpp with cmake for Unix platforms..."
        
        # Clone whisper.cpp from OFFICIAL repository
        git clone https://github.com/ggml-org/whisper.cpp.git /tmp/whisper.cpp
        cd /tmp/whisper.cpp
        
        # Use modern cmake build approach
        cmake -B build -DCMAKE_BUILD_TYPE=Release
        cmake --build build --config Release --parallel $(nproc 2>/dev/null || sysctl -n hw.ncpu || echo 4)
        
        # Find the whisper binary (different names in different versions)
        WHISPER_BINARY=""
        for name in "whisper-cli" "main" "whisper"; do
          if [ -f "build/bin/${name}" ]; then
            WHISPER_BINARY="build/bin/${name}"
            break
          elif [ -f "bin/${name}" ]; then
            WHISPER_BINARY="bin/${name}"
            break
          fi
        done
        
        if [ -z "$WHISPER_BINARY" ]; then
          echo "‚ùå Could not find whisper binary"
          echo "üìã Available files in build/bin:"
          ls -la build/bin/ 2>/dev/null || echo "No build/bin directory"
          echo "üìã Available files in bin:"
          ls -la bin/ 2>/dev/null || echo "No bin directory"
          exit 1
        fi
        
        echo "‚úÖ Found whisper binary at: $WHISPER_BINARY"
        
        # Copy to project binaries directory
        mkdir -p "$GITHUB_WORKSPACE/binaries"
        cp "$WHISPER_BINARY" "$GITHUB_WORKSPACE/binaries/whisper"
        chmod +x "$GITHUB_WORKSPACE/binaries/whisper"
        
        # Verify the binary works
        echo "üß™ Testing binary..."
        "$GITHUB_WORKSPACE/binaries/whisper" --help || echo "Binary test failed but continuing..."
        
        echo "‚úÖ whisper.cpp built and installed successfully"

    # Build whisper.cpp from source - Windows with MSVC (official approach)
    - name: Build whisper.cpp (Windows) - Official MSVC Approach
      if: runner.os == 'Windows'
      shell: pwsh
      run: |
        Write-Host "üî® Building whisper.cpp for Windows using MSVC (official approach)..."
        
        # Clone whisper.cpp from OFFICIAL repository
        git clone https://github.com/ggml-org/whisper.cpp.git C:\temp\whisper.cpp
        Set-Location C:\temp\whisper.cpp
        
        Write-Host "‚úÖ Cloned whisper.cpp from official repository"
        
        # Configure with MSVC (same as official whisper.cpp CI)
        cmake -S . -B ./build -A x64 -DCMAKE_BUILD_TYPE=Release -DBUILD_SHARED_LIBS=ON
        
        Write-Host "‚úÖ Configured with MSVC"
        
        # Build using MSBuild (Visual Studio's build system)
        Set-Location build
        msbuild ALL_BUILD.vcxproj -t:build -p:configuration=Release -p:platform=x64
        
        Write-Host "‚úÖ Built with MSBuild"
        
        # Find and copy the whisper executable and DLLs
        $buildDir = "bin\Release"
        $targetDir = "$env:GITHUB_WORKSPACE\binaries"
        
        # Create target directory
        New-Item -ItemType Directory -Force -Path $targetDir
        
        # Find the main executable (try different names)
        $exeNames = @("main.exe", "whisper-cli.exe", "whisper.exe")
        $foundExe = $null
        
        foreach ($exeName in $exeNames) {
            $exePath = Join-Path $buildDir $exeName
            if (Test-Path $exePath) {
                $foundExe = $exePath
                break
            }
        }
        
        if ($foundExe) {
            Copy-Item $foundExe "$targetDir\whisper.exe" -Force
            Write-Host "‚úÖ Copied $foundExe -> whisper.exe"
        } else {
            Write-Host "‚ùå Could not find whisper executable"
            Write-Host "Available files in build directory:"
            Write-Host "Directory: $buildDir"
            Get-ChildItem $buildDir -ErrorAction SilentlyContinue | Select-Object Name, Length
            exit 1
        }
        
        # Copy all DLLs from the build directory
        $dlls = Get-ChildItem -Path $buildDir -Filter "*.dll" -ErrorAction SilentlyContinue
        
        if ($dlls.Count -gt 0) {
            foreach ($dll in $dlls) {
                Copy-Item $dll.FullName $targetDir -Force
                Write-Host "‚úÖ Copied DLL: $($dll.Name)"
            }
            Write-Host "üìã Total DLLs copied: $($dlls.Count)"
        } else {
            Write-Host "‚ö†Ô∏è No DLLs found in build directory"
        }
        
        Write-Host "‚úÖ whisper.cpp built and installed successfully"

    # Package Visual C++ Runtime Dependencies (Windows)
    - name: Package VC++ Runtime (Windows)
      if: runner.os == 'Windows'
      shell: pwsh
      run: |
        Write-Host "üì¶ Packaging Visual C++ Runtime Dependencies..."
        
        $targetDir = "$env:GITHUB_WORKSPACE\binaries"
        
        # Download VC++ Redistributable for users who need it
        $vcredistUrl = "https://aka.ms/vs/17/release/vc_redist.x64.exe"
        $vcredistPath = "$targetDir\vc_redist.x64.exe"
        
        try {
            Write-Host "‚¨áÔ∏è Downloading VC++ Redistributable..."
            Invoke-WebRequest -Uri $vcredistUrl -OutFile $vcredistPath -UseBasicParsing
            Write-Host "‚úÖ Downloaded VC++ Redistributable installer"
        } catch {
            Write-Host "‚ö†Ô∏è Failed to download VC++ Redistributable: $($_.Exception.Message)"
        }
        
        # Try to copy runtime DLLs from system (if available)
        $runtimeDlls = @(
            @{ Name = "msvcp140.dll"; Path = "C:\Windows\System32\msvcp140.dll" },
            @{ Name = "vcruntime140.dll"; Path = "C:\Windows\System32\vcruntime140.dll" },
            @{ Name = "vcruntime140_1.dll"; Path = "C:\Windows\System32\vcruntime140_1.dll" }
        )
        
        foreach ($dll in $runtimeDlls) {
            if (Test-Path $dll.Path) {
                try {
                    Copy-Item $dll.Path $targetDir -Force
                    Write-Host "‚úÖ Copied runtime DLL: $($dll.Name)"
                } catch {
                    Write-Host "‚ö†Ô∏è Could not copy $($dll.Name): $($_.Exception.Message)"
                }
            } else {
                Write-Host "‚ö†Ô∏è Runtime DLL not found: $($dll.Name)"
            }
        }

    # Test Windows binary
    - name: Test Windows binary
      if: runner.os == 'Windows'
      shell: pwsh
      run: |
        Write-Host "üß™ Testing Windows binary..."
        
        $binaryPath = "$env:GITHUB_WORKSPACE\binaries\whisper.exe"
        
        if (-not (Test-Path $binaryPath)) {
            Write-Host "‚ùå Binary not found at: $binaryPath"
            exit 1
        }
        
        # Set PATH to include our binaries directory for DLL loading
        $env:PATH = "$env:GITHUB_WORKSPACE\binaries;$env:PATH"
        
        try {
            $process = Start-Process -FilePath $binaryPath -ArgumentList "--help" -Wait -NoNewWindow -PassThru -RedirectStandardOutput "test_output.txt" -RedirectStandardError "test_error.txt"
            
            if ($process.ExitCode -eq 0) {
                Write-Host "‚úÖ Binary test passed!"
                
                # Show some output
                if (Test-Path "test_output.txt") {
                    $output = Get-Content "test_output.txt" -Raw
                    $firstLine = ($output -split "`n")[0]
                    Write-Host "üìã Binary works: $firstLine"
                }
            } else {
                Write-Host "‚ö†Ô∏è Binary test failed with exit code: $($process.ExitCode)"
                
                # Check for specific error codes
                if ($process.ExitCode -eq 3221225781 -or $process.ExitCode -eq -1073741515) {
                    Write-Host "‚ùå This appears to be a missing Visual C++ runtime issue"
                    Write-Host "üí° The bundled vc_redist.x64.exe should fix this for end users"
                } else {
                    Write-Host "‚ùå Unknown error, but continuing with build..."
                }
                
                if (Test-Path "test_error.txt") {
                    $error = Get-Content "test_error.txt" -Raw
                    Write-Host "Error output: $($error.Substring(0, [Math]::Min(200, $error.Length)))"
                }
            }
        } catch {
            Write-Host "‚ö†Ô∏è Binary test failed with exception: $($_.Exception.Message)"
            Write-Host "üí° This may be resolved by the VC++ redistributable for end users"
        } finally {
            # Clean up test files
            Remove-Item "test_output.txt" -ErrorAction SilentlyContinue
            Remove-Item "test_error.txt" -ErrorAction SilentlyContinue
        }
        
        # Show final directory contents
        Write-Host "üìã Final binaries directory contents:"
        Get-ChildItem "$env:GITHUB_WORKSPACE\binaries" | Format-Table Name, Length -AutoSize

    # Download tiny model for inclusion
    - name: Download tiny model
      run: |
        mkdir -p models
        curl -L -o models/ggml-tiny.bin https://huggingface.co/ggerganov/whisper.cpp/resolve/main/ggml-tiny.bin

    # Build renderer
    - name: Build renderer
      run: |
        cd src/renderer/whisperdesk-ui
        pnpm run build

    # Configure electron-builder with FIXED binary packaging
    - name: Configure electron-builder (Unix) - FIXED
      if: runner.os != 'Windows'
      run: |
        echo "üîß Configuring electron-builder with BINARY PACKAGING and platform-specific naming..."
        
        # Create electron-builder config with proper binary packaging and unique naming and unique naming
        cat > electron-builder-fixed.json << 'EOF'
        {
          "appId": "com.yourcompany.whisperdesk",
          "productName": "WhisperDesk Enhanced",
          "directories": {
            "output": "dist"
          },
          "artifactName": "${productName}-${version}-${os}-${arch}.${ext}",
          "files": [
            "src/main/**/*",
            "src/renderer/whisperdesk-ui/dist/**/*",
            "src/shared/**/*",
            "node_modules/**/*",
            "package.json"
          ],
          "extraResources": [
            {
              "from": "binaries/",
              "to": "binaries/",
              "filter": ["**/*"]
            },
            {
              "from": "models/",
              "to": "models/",
              "filter": ["**/*"]
            }
          ],
          "win": {
            "target": [
              {
                "target": "nsis",
                "arch": ["x64"]
              },
              {
                "target": "zip",
                "arch": ["x64"]
              }
            ],
            "publisherName": "WhisperDesk Team",
            "verifyUpdateCodeSignature": false
          },
          "mac": {
            "target": [
              {
                "target": "dmg",
                "arch": ["x64", "arm64"]
              },
              {
                "target": "zip",
                "arch": ["x64", "arm64"]
              }
            ],
            "category": "public.app-category.productivity",
            "hardenedRuntime": true,
            "gatekeeperAssess": false
          },
          "linux": {
            "target": [
              {
                "target": "AppImage",
                "arch": ["x64"]
              },
              {
                "target": "deb",
                "arch": ["x64"]
              },
              {
                "target": "rpm",
                "arch": ["x64"]
              },
              {
                "target": "tar.gz",
                "arch": ["x64"]
              }
            ],
            "category": "AudioVideo"
          }
        }
        EOF
        
        echo "‚úÖ Electron-builder configuration created with PLATFORM-SPECIFIC NAMING"

    - name: Configure electron-builder (Windows) - FIXED
      if: runner.os == 'Windows'
      shell: pwsh
      run: |
        Write-Host "üîß Configuring electron-builder with BINARY PACKAGING and platform-specific naming..."
        
        # Create electron-builder config with proper binary packaging
        $config = @"
        {
          "appId": "com.yourcompany.whisperdesk",
          "productName": "WhisperDesk Enhanced",
          "directories": {
            "output": "dist"
          },
          "artifactName": "`${productName}-`${version}-`${os}-`${arch}.`${ext}",
          "files": [
            "src/main/**/*",
            "src/renderer/whisperdesk-ui/dist/**/*",
            "src/shared/**/*",
            "node_modules/**/*",
            "package.json"
          ],
          "extraResources": [
            {
              "from": "binaries/",
              "to": "binaries/",
              "filter": ["**/*"]
            },
            {
              "from": "models/",
              "to": "models/",
              "filter": ["**/*"]
            }
          ],
          "win": {
            "target": [
              {
                "target": "nsis",
                "arch": ["x64"]
              },
              {
                "target": "zip",
                "arch": ["x64"]
              }
            ],
            "publisherName": "WhisperDesk Team",
            "verifyUpdateCodeSignature": false
          },
          "mac": {
            "target": [
              {
                "target": "dmg",
                "arch": ["x64", "arm64"]
              },
              {
                "target": "zip",
                "arch": ["x64", "arm64"]
              }
            ],
            "category": "public.app-category.productivity",
            "hardenedRuntime": true,
            "gatekeeperAssess": false
          },
          "linux": {
            "target": [
              {
                "target": "AppImage",
                "arch": ["x64"]
              },
              {
                "target": "deb",
                "arch": ["x64"]
              },
              {
                "target": "rpm",
                "arch": ["x64"]
              },
              {
                "target": "tar.gz",
                "arch": ["x64"]
              }
            ],
            "category": "AudioVideo"
          }
        }
        "@
        
        # Write to file
        $config | Out-File -FilePath "electron-builder-fixed.json" -Encoding UTF8
        
        Write-Host "‚úÖ Electron-builder configuration created with PLATFORM-SPECIFIC NAMING"

    # Verify version before building
    - name: Verify version configuration
      shell: bash
      run: |
        echo "üîç Verifying version configuration..."
        echo "üìã Git ref: ${{ github.ref }}"
        echo "üìã Git ref type: ${{ github.ref_type }}"
        echo "üìã Git ref name: ${{ github.ref_name }}"
        echo "üìã App version (env): $APP_VERSION"
        echo "üìã Package.json version: $(node -p "require('./package.json').version")"
        
        # Verify versions match
        PACKAGE_VERSION=$(node -p "require('./package.json').version")
        if [ "$APP_VERSION" != "$PACKAGE_VERSION" ]; then
          echo "‚ö†Ô∏è Warning: Environment version ($APP_VERSION) differs from package.json ($PACKAGE_VERSION)"
        else
          echo "‚úÖ Version consistency verified: $APP_VERSION"
        fi

    # Verify binary before building Electron app
    - name: Verify whisper binary
      shell: bash
      run: |
        echo "üîç Verifying whisper binary..."
        
        if [ "${{ runner.os }}" = "Windows" ]; then
          BINARY_PATH="binaries/whisper.exe"
        else
          BINARY_PATH="binaries/whisper"
        fi
        
        if [ -f "$BINARY_PATH" ]; then
          echo "‚úÖ Binary exists at: $BINARY_PATH"
          ls -la "$BINARY_PATH"
        else
          echo "‚ùå Binary not found at: $BINARY_PATH"
          echo "üìã Contents of binaries directory:"
          ls -la binaries/ || echo "No binaries directory"
          exit 1
        fi

    # Build Electron app for specific platform
    - name: Build Electron app (macOS)
      if: matrix.platform == 'darwin'
      env:
        CSC_IDENTITY_AUTO_DISCOVERY: false
      run: |
        npm run build:skip-whisper
        npx electron-builder ${{ matrix.electron_target }} --publish=never --config electron-builder-fixed.json

    - name: Build Electron app (Linux)
      if: matrix.platform == 'linux'
      run: |
        npm run build:skip-whisper
        npx electron-builder ${{ matrix.electron_target }} --publish=never --config electron-builder-fixed.json

    - name: Build Electron app (Windows)
      if: matrix.platform == 'win32'
      env:
        CSC_IDENTITY_AUTO_DISCOVERY: false
      run: |
        npm run build:skip-whisper
        npx electron-builder ${{ matrix.electron_target }} --publish=never --config electron-builder-fixed.json

    # VERIFY: Check for unwanted ia32 builds
    - name: Verify no ia32 builds created
      shell: bash
      run: |
        echo "üîç Checking for unwanted ia32/32-bit builds..."
        
        # Check for ia32 in filenames
        if find dist/ -name "*ia32*" 2>/dev/null | grep -q .; then
          echo "‚ùå ERROR: Found ia32 builds when only x64 was expected!"
          find dist/ -name "*ia32*"
          exit 1
        else
          echo "‚úÖ No ia32 builds found - good!"
        fi
        
        # List all built files for verification
        echo "üìã Built files:"
        find dist/ -type f -name "*.exe" -o -name "*.dmg" -o -name "*.zip" -o -name "*.AppImage" -o -name "*.deb" -o -name "*.rpm" -o -name "*.tar.gz" | sort

    # Upload artifacts with clear platform separation
    - name: Upload macOS artifacts
      if: matrix.platform == 'darwin'
      uses: actions/upload-artifact@v4
      with:
        name: ${{ matrix.artifact }}
        path: |
          dist/*.dmg
          dist/*.zip
        retention-days: 30

    - name: Upload Linux artifacts
      if: matrix.platform == 'linux'
      uses: actions/upload-artifact@v4
      with:
        name: ${{ matrix.artifact }}
        path: |
          dist/*.AppImage
          dist/*.deb
          dist/*.rpm
          dist/*.tar.gz
        retention-days: 30

    - name: Upload Windows artifacts
      if: matrix.platform == 'win32'
      uses: actions/upload-artifact@v4
      with:
        name: ${{ matrix.artifact }}
        path: |
          dist/*.exe
          dist/*.zip
        retention-days: 30

  # Create release with proper file organization
  release:
    if: startsWith(github.ref, 'refs/tags/v')
    needs: build
    runs-on: ubuntu-latest
    
    permissions:
      contents: write
      actions: read
      id-token: write
      
    steps:
    - name: Checkout code
      uses: actions/checkout@v4
      with:
        fetch-depth: 0

    - name: Download all artifacts
      uses: actions/download-artifact@v4
      with:
        path: artifacts

    - name: Set clean version for release notes
      id: version
      run: |
        # Extract clean version (without 'v' prefix) for release notes
        CLEAN_VERSION="${{ github.ref_name }}"
        CLEAN_VERSION="${CLEAN_VERSION#v}"
        echo "clean=$CLEAN_VERSION" >> $GITHUB_OUTPUT
        echo "üè∑Ô∏è Clean version for release notes: $CLEAN_VERSION"

    - name: Organize release files
      run: |
        echo "üîß Organizing release files by platform with deduplication..."
        mkdir -p release-files
        
        # Function to copy file with unique naming if duplicate exists
        copy_unique() {
          local src="$1"
          local dst="$2"
          local filename=$(basename "$src")
          local counter=1
          local target="$dst/$filename"
          
          # If file already exists, add counter
          while [ -f "$target" ]; do
            local base="${filename%.*}"
            local ext="${filename##*.}"
            if [ "$base" = "$filename" ]; then
              # No extension
              target="$dst/${base}-${counter}"
            else
              # Has extension
              target="$dst/${base}-${counter}.${ext}"
            fi
            counter=$((counter + 1))
          done
          
          cp "$src" "$target"
          echo "üìÅ Copied: $src -> $target"
        }
        
        # Process each artifact directory
        for artifact_dir in artifacts/*/; do
          echo "üîç Processing: $artifact_dir"
          
          # Determine platform from directory name
          if [[ "$artifact_dir" == *"windows"* ]]; then
            platform="windows"
          elif [[ "$artifact_dir" == *"mac"* ]]; then
            platform="macos"
          elif [[ "$artifact_dir" == *"linux"* ]]; then
            platform="linux"
          else
            echo "‚ö†Ô∏è Unknown platform for $artifact_dir, skipping..."
            continue
          fi
          
          # Create platform directory
          mkdir -p "release-files/$platform"
          
          # Copy files with deduplication
          find "$artifact_dir" -type f \( -name "*.exe" -o -name "*.dmg" -o -name "*.zip" -o -name "*.AppImage" -o -name "*.deb" -o -name "*.rpm" -o -name "*.tar.gz" \) | while read -r file; do
            copy_unique "$file" "release-files/$platform"
          done
        done
        
        echo "üìã Final release file structure:"
        find release-files/ -type f | sort

    - name: Create Release
      uses: softprops/action-gh-release@v1
      with:
        files: release-files/**/*
        draft: false
        prerelease: false
        generate_release_notes: true
        name: "WhisperDesk Enhanced ${{ github.ref_name }}"
        body: |
          ## WhisperDesk Enhanced ${{ github.ref_name }}
          
          üéâ **New Release Available!**
          
          ### üì¶ Download Options:
          
          **üñ•Ô∏è Windows (64-bit only)**:
          - `WhisperDesk-Enhanced-${{ steps.version.outputs.clean }}-win-x64.exe` - Installer
          - `WhisperDesk-Enhanced-${{ steps.version.outputs.clean }}-win-x64.zip` - Portable version
          
          **üçé macOS**:
          - `WhisperDesk-Enhanced-${{ steps.version.outputs.clean }}-mac-x64.dmg` - Intel Macs
          - `WhisperDesk-Enhanced-${{ steps.version.outputs.clean }}-mac-x64.zip` - Intel Macs (Portable)
          - `WhisperDesk-Enhanced-${{ steps.version.outputs.clean }}-mac-arm64.dmg` - Apple Silicon Macs
          - `WhisperDesk-Enhanced-${{ steps.version.outputs.clean }}-mac-arm64.zip` - Apple Silicon Macs (Portable)
          
          **üêß Linux**:
          - `WhisperDesk-Enhanced-${{ steps.version.outputs.clean }}-linux-x64.AppImage` - Portable (recommended)
          - `WhisperDesk-Enhanced-${{ steps.version.outputs.clean }}-linux-x64.deb` - Debian/Ubuntu package
          - `WhisperDesk-Enhanced-${{ steps.version.outputs.clean }}-linux-x64.rpm` - Red Hat/Fedora package
          - `WhisperDesk-Enhanced-${{ steps.version.outputs.clean }}-linux-x64.tar.gz` - Generic Linux archive
          
          ### ‚ú® Features:
          - üéµ Native whisper.cpp integration for fast, offline transcription
          - üì± Cross-platform support (Windows, macOS, Linux)
          - üîÑ Real-time progress tracking
          - üíæ Persistent state management
          - üéØ Multiple model support (Tiny, Base, Small, Medium, Large)
          - üìÅ Drag & drop file upload
          - üé® Modern, responsive UI
          
          ### üöÄ Quick Start:
          1. **Download**: Choose the appropriate file for your platform above
          2. **Install**: 
             - Windows: Run the installer or extract the zip
             - macOS: Open the .dmg and drag to Applications, or extract the zip
             - Linux: Make AppImage executable, install package, or extract archive
          3. **Setup**: Launch WhisperDesk and go to Models tab
          4. **Download Model**: Download a transcription model (start with Tiny)
          5. **Transcribe**: Upload audio/video files and start transcribing!
          
          ### üîß Troubleshooting:
          - **Windows**: If you get a "missing DLL" error, run the included `vc_redist.x64.exe` redistributable
          - **macOS**: Right-click ‚Üí Open if blocked by Gatekeeper
          - **Linux**: `chmod +x *.AppImage` to make executable
          
          ---
          Auto-generated release notes below ‚¨áÔ∏è
      env:
        GITHUB_TOKEN: ${{ secrets.GITHUB_TOKEN }}